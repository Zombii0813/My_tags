# 更新日志

## v0.0.5 (2026-02-28)

### 缩略图系统优化（优化指南 1.2）

#### 可视区域+缓冲区预加载
- 新增 `ViewportRange` 类管理可视区域范围
- 实现 `calculate_viewport_range()` 智能计算可见项目
- 上下各 `BUFFER_ITEMS=10` 个项目缓冲区预加载
- 防抖机制：`PRELOAD_DELAY_MS=100ms` 延迟加载避免滚动卡顿
- 多线程并发：最大 `MAX_PRELOAD_WORKERS=4` 个预加载线程

#### 动态质量调整
- 根据缩略图尺寸自动选择最佳压缩质量：
  - ≤64px: 质量 60（极小图标）
  - ≤100px: 质量 70（小图标）
  - ≤200px: 质量 80（中等缩略图）
  - ≤400px: 质量 85（大缩略图）
  - >400px: 质量 90（预览尺寸）
- 自适应 WebP 压缩方法（method=6 最优压缩）

#### JPEG 回退支持
- 新增 `ThumbnailFormat` 类自动检测 WebP 支持
- 不支持 WebP 的系统自动使用 JPEG 格式
- JPEG 使用渐进式编码(progressive)优化加载体验
- 格式检测缓存避免重复测试

#### Retina/高分屏支持
- 新增 `ThumbnailSize` 类管理逻辑/物理尺寸
- 支持设备像素比(DPR)检测：`get_device_pixel_ratio()`
- 自动为高分屏生成 2x 甚至 3x 版本缩略图
- 缓存键包含 DPR 信息，确保分辨率切换时正确命中缓存

#### 其他改进
- EXIF 自动旋转：读取图片方向标签自动校正
- 线程池管理：独立配置最大线程数，避免资源竞争
- 防抖预加载：滚动停止后才触发预加载，减少无效计算

---

## v0.0.4 (2026-02-28)

### 数据库层面优化（优化指南 1.1）

#### 新增索引
- 为 `files` 表添加复合索引：
  - `idx_files_type` - 加速文件类型筛选
  - `idx_files_name` - 加速文件名搜索
  - `idx_files_path` - 加速路径查找
  - `idx_files_modified_at` - 加速修改时间排序
- 为 `file_tags` 关联表添加索引：
  - `idx_file_tags_tag_id` - 加速标签关联查询
  - `idx_file_tags_file_id` - 加速文件标签查询

#### FTS5 全文搜索集成
- 新增 `files_fts` 虚拟表，使用 SQLite FTS5 扩展
- 支持高级搜索语法：
  - 前缀搜索: `report*`
  - 短语搜索: `"annual report"`
  - 布尔搜索: `report AND 2024`
  - 排除搜索: `report NOT draft`
- 自动维护触发器保持 FTS 表与 `files` 表同步
- 搜索时自动优先使用 FTS，无 FTS5 时回退到 LIKE

#### 连接池优化
- 实现 `QueuePool` 连接池，配置参数：
  - `pool_size=5` - 基础连接数
  - `max_overflow=10` - 最大溢出连接
  - `pool_timeout=30` - 连接获取超时
  - `pool_recycle=3600` - 连接回收时间
  - `pool_pre_ping=True` - 自动检测失效连接
- 新增 `SessionContext` 上下文管理器简化事务管理
- 新增 `rebuild_fts_index()` 方法用于重建 FTS 索引

#### 批量操作优化
- `Repo.bulk_upsert_files()` - 批量插入/更新文件，默认批次 500
- `Repo.bulk_create_tags()` - 批量创建标签，自动去重
- `Repo.attach_tags_to_files()` - 批量绑定文件与标签
- 内部实现 `Repo._process_batch()` 优化批量查询逻辑

#### 新增搜索功能
- `Repo.search_by_fts()` - 纯 FTS5 搜索接口
- `SearchQuery.use_fts` - 控制是否启用 FTS5

---

## v0.0.3 (2026-02-23)

### 新增功能
- 支持清理旧的工作目录数据库（保留当前工作目录）

### 界面优化
- 优化界面布局, 美化图标
- 新增界面皮肤
- 文件操作改为右键文件菜单显示
- 文件列表滚动效果优化

### 修复
- 启动时恢复上次工作目录数据库，标签列表正常显示
- 标签筛选时正确使用真实标签名，过滤结果准确

---

## v0.0.2 (2026-02-11)

### 新增功能
- 缩略图缓存从数据目录解耦，支持独立配置路径
- 缩略图内存 LRU 缓存 + WebP 磁盘缓存
- 网格视图缩略图后台预热
- Windows 平台优先使用系统 Shell 缩略图（非图片类型可获取预览）

### 性能优化
- 网格视图滚轮滚动速度提升

### 已知限制
- Windows Shell 缩略图仅在 Windows 上生效，其他平台仍使用现有回退逻辑

### 变更
- 文件夹模式改为树 + 文件列表双栏布局，文件列表支持网格缩略图显示

---

## v0.0.1 (2026-02-10)

### 新增功能
- 基础架构搭建：Python + PySide6 + SQLAlchemy + SQLite
- 工作空间管理：支持环境变量与 `.env` 配置工作目录
- 文件索引：全量扫描、增量监听、索引清理
- 标签系统：新增/删除、批量绑定/移除、交集/并集筛选
- 文件浏览：列表/缩略图网格、按文件夹层级展开与折叠
- 筛选与排序：类型筛选、名称正序/倒序、修改时间、大小排序
- 文件操作：打开文件/文件夹、移动/复制、索引删除
- 详情面板：文件信息展示、选中数量提示、图片预览
- 视频缩略图：网格视图下生成（依赖 ffmpeg）

### 性能优化
- 扫描遍历改用 `os.scandir` 递归
- 扫描过程中分批提交数据库
- 默认不计算哈希以提升速度

### 已知限制
- 视频缩略图依赖 `ffmpeg`，需提前安装并配置 PATH 或 `MYTAGS_FFMPEG`
- 仅支持图片预览，视频/文档预览未实现
- 时长排序未实现（暂无时长字段）
